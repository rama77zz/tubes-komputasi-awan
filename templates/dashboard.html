<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>InvoiceInAja</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <script type="text/javascript"
          src="https://app.sandbox.midtrans.com/snap/snap.js"
          data-client-key="{{ client_key }}"></script>

  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800">

<nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50 border-b border-gray-200">
  <div class="flex items-center gap-2">
    <img src="{{ url_for('static', filename='new1invoiceinaja.png') }}"
         class="h-10 w-auto object-contain"
         alt="Logo Aplikasi"
         onerror="this.style.display='none'; document.getElementById('backupLogo').classList.remove('hidden');" />
    <div id="backupLogo" class="hidden font-bold">InvoiceInAja</div>
  </div>

  <div class="flex items-center gap-4">
    <div class="text-right hidden md:block">
      <p class="font-semibold text-sm">{{ user.username }}</p>
      {% if user.is_premium %}
        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full font-bold border border-indigo-200">PREMIUM MEMBER</span>
      {% elif user.id %}
        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold border border-green-200">FREE MEMBER</span>
      {% else %}
        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-bold border border-gray-300">MODE TAMU</span>
      {% endif %}
    </div>

    {% if not user.is_premium %}
      <button onclick="goPremium()"
              class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-5 py-2 rounded-full shadow hover:shadow-md transition text-sm font-bold flex items-center gap-2 hover:scale-105">
        <i class="fas fa-crown"></i> UPGRADE
      </button>
    {% endif %}

   {% if user.id %}
      <a href="{{ url_for('logout') }}" class="text-gray-500 hover:text-red-500 ml-2 transition" title="Keluar">
          <i class="fas fa-sign-out-alt fa-lg"></i>
      </a>
  {% else %}
      <a href="{{ url_for('login') }}" class="bg-indigo-600 text-white px-5 py-2 rounded-full text-sm hover:bg-indigo-700 font-bold ml-2 shadow-sm transition">
           Masuk / Daftar
      </a>
  {% endif %}
  </div>
</nav>

<div class="container mx-auto p-6 flex flex-col lg:flex-row gap-8">

  <!-- KIRI -->
  <div class="w-full lg:w-1/3 space-y-6">

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
      <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-700">
        <i class="fas fa-palette text-indigo-500"></i> Desain Invoice
      </h3>

      <div class="space-y-3">
        <label class="flex items-center p-4 border rounded-xl bg-gray-50 border-gray-200 cursor-pointer hover:bg-gray-100 transition">
          <input type="radio" name="tpl_select" value="basic" checked onchange="setTemplate(this.value)"
                 class="mr-4 text-indigo-600 w-5 h-5 focus:ring-indigo-500">
          <div>
            <span class="block font-bold text-sm">Basic</span>
            <span class="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded-full font-bold">Gratis</span>
          </div>
        </label>

        <label class="relative flex items-center p-4 border rounded-xl transition cursor-pointer hover:bg-indigo-50 border-indigo-200 {% if user.is_premium %}bg-white{% else %}bg-gray-100 opacity-70{% endif %}">
          <input type="radio" name="tpl_select" value="modern" {% if not user.is_premium %}disabled{% endif %}
                 onchange="setTemplate(this.value)"
                 class="mr-4 text-indigo-600 w-5 h-5 focus:ring-indigo-500">
          <div class="flex-1">
            <span class="block font-bold text-sm text-indigo-900">Modern</span>
            <span class="text-xs text-indigo-600 font-bold flex items-center gap-1"><i class="fas fa-crown"></i> Premium</span>
          </div>
          {% if not user.is_premium %}<i class="fas fa-lock text-gray-400 absolute right-4 text-lg"></i>{% endif %}
        </label>

        <label class="relative flex items-center p-4 border rounded-xl transition cursor-pointer hover:bg-orange-50 border-orange-200 {% if user.is_premium %}bg-white{% else %}bg-gray-100 opacity-70{% endif %}">
          <input type="radio" name="tpl_select" value="corporate" {% if not user.is_premium %}disabled{% endif %}
                 onchange="setTemplate(this.value)"
                 class="mr-4 text-orange-600 w-5 h-5 focus:ring-orange-500">
          <div class="flex-1">
            <span class="block font-bold text-sm text-orange-900">Corporate</span>
            <span class="text-xs text-orange-600 font-bold flex items-center gap-1"><i class="fas fa-crown"></i> Premium</span>
          </div>
          {% if not user.is_premium %}<i class="fas fa-lock text-gray-400 absolute right-4 text-lg"></i>{% endif %}
        </label>
      </div>
    </div>

    <!-- Kustomisasi Premium -->
    <div id="premiumSettings" class="bg-white p-6 rounded-2xl shadow-sm border border-indigo-200 {% if user.is_premium %}opacity-100{% else %}opacity-70 pointer-events-none{% endif %}">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-700 flex items-center gap-2">
          <i class="fas fa-cogs text-indigo-500"></i> Kustomisasi Premium
        </h3>
        {% if not user.is_premium %}<i class="fas fa-lock text-gray-400 text-lg"></i>{% endif %}
      </div>

      <div class="space-y-6">

        <!-- Logo -->
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-2">Logo Perusahaan</label>
          <div class="flex items-center gap-4">
            <div class="h-16 w-16 bg-gray-100 border rounded-lg flex items-center justify-center overflow-hidden relative">
              {% if user.company_logo %}
                <img id="previewLogo" src="{{ url_for('static', filename='uploads/' ~ user.company_logo) }}" class="h-full object-contain" />
              {% else %}
                <i class="fas fa-image text-gray-300 text-2xl" id="noLogoIcon"></i>
              {% endif %}
            </div>

            <div>
              <input type="file" id="logoIn" class="hidden" accept="image/*" onchange="uploadFile('logo')">
              <label for="logoIn" class="cursor-pointer bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-50 transition font-semibold shadow-sm">
                Upload Logo
              </label>
              <p class="text-xs text-gray-400 mt-1">PNG/JPG, transparan disarankan.</p>
            </div>
          </div>
        </div>

        <!-- Signature -->
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-2">Tanda Tangan Digital</label>
          <div class="flex items-center gap-4">
            <div class="h-12 w-24 bg-gray-100 border rounded-lg flex items-center justify-center overflow-hidden relative">
              {% if user.signature_file %}
                <img id="previewSig" src="{{ url_for('static', filename='uploads/' ~ user.signature_file) }}" class="h-full object-contain" />
              {% else %}
                <i class="fas fa-file-signature text-gray-300 text-xl" id="noSigIcon"></i>
              {% endif %}
            </div>

            <div>
              <input type="file" id="sigIn" class="hidden" accept="image/*" onchange="uploadFile('signature')">
              <label for="sigIn" class="cursor-pointer bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-50 transition font-semibold shadow-sm">
                Upload TTD
              </label>
              <p class="text-xs text-gray-400 mt-1">PNG transparan (wajib).</p>
            </div>
          </div>
        </div>

        <!-- Address -->
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-2">Alamat & Kontak Pencetak</label>
          <textarea id="addressIn" rows="3"
                    class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none transition text-sm resize-none"
                    placeholder="Contoh: Jl. Sudirman No. 1, Jakarta. Telp 021-123456">{{ user.company_address or '' }}</textarea>
          <button type="button" onclick="updateAddress()"
                  class="mt-2 text-indigo-600 text-sm font-semibold hover:underline">
            Simpan Alamat
          </button>
        </div>

        <!-- NEW: 3 field profile -->
        <div class="pt-2 border-t border-gray-200">
          <label class="block text-sm font-semibold text-gray-600 mb-2">Profil Invoice (Header & Tanda Tangan)</label>

          <div class="space-y-3">
            <div>
              <label class="block text-xs font-semibold text-gray-500 mb-1">Nama Perusahaan</label>
              <input id="companyNameIn" type="text"
                     class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none transition text-sm"
                     value="{{ user.company_name or (user.username ~ ' CORP.') }}">
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-500 mb-1">Nama Penanda Tangan</label>
              <input id="sigNameIn" type="text"
                     class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none transition text-sm"
                     value="{{ user.signature_name or user.username }}">
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-500 mb-1">Jabatan / Title</label>
              <input id="sigTitleIn" type="text"
                     class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none transition text-sm"
                     value="{{ user.signature_title or 'Authorized Signature' }}">
            </div>

            <button type="button" onclick="saveInvoiceProfile()"
                    class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow">
              Simpan Profil Invoice
            </button>

            <p class="text-xs text-gray-400">
              Profil ini dipakai untuk template Modern & Corporate (header perusahaan + blok tanda tangan).
            </p>
          </div>
        </div>

      </div>
    </div>

    <!-- Warna + judul header -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Warna Background</label>
          <input type="color" id="bgColorPicker" value="#ffffff" class="w-full h-10 p-1 rounded cursor-pointer border">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Warna Garis/Aksen</label>
          <input type="color" id="lineColorPicker" value="#000000" class="w-full h-10 p-1 rounded cursor-pointer border">
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-semibold text-gray-600 mb-1">Judul Header Invoice</label>
        <input type="text" id="headerTitleInput" value="INVOICE"
               class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none transition text-sm">
      </div>
    </div>

  </div>

  <!-- KANAN -->
  <div class="w-full lg:w-2/3 bg-white p-8 rounded-2xl shadow-sm border border-gray-200 h-fit">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center gap-3">
      <i class="fas fa-file-invoice text-indigo-600"></i> Buat Invoice
    </h2>

    <form action="/generate-invoice" method="POST" target="_blank" id="invoiceForm">
      <!-- hidden yg diisi sebelum submit -->
      <input type="hidden" name="template" id="finalTemplate" value="basic">
      <input type="hidden" name="bg_color" id="finalBgColor" value="ffffff">
      <input type="hidden" name="line_color" id="finalLineColor" value="000000">
      <input type="hidden" name="header_title" id="finalHeaderTitle" value="INVOICE">

      <div class="mb-8">
        <label class="block font-bold text-sm mb-2 text-gray-700">Kepada Yth. (Pelanggan)</label>
        <input type="text" name="customer_name" required
               class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition text-gray-700 placeholder-gray-400"
               placeholder="Nama Perusahaan Pelanggan">
      </div>

      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <label class="block font-bold text-sm text-gray-700">Daftar Item</label>
          <span class="text-xs text-gray-500" id="itemCount">Maksimal 10 Item</span>
        </div>

        <div class="overflow-x-auto border rounded-xl">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600 border-b">
              <tr>
                <th class="p-3 text-left font-semibold">Deskripsi</th>
                <th class="p-3 w-24 text-center font-semibold">Qty</th>
                <th class="p-3 w-40 text-right font-semibold">Harga (Rp)</th>
                <th class="p-3 w-14 text-center"></th>
              </tr>
            </thead>
            <tbody id="items" class="divide-y divide-gray-100 bg-white"></tbody>
          </table>
        </div>
      </div>

      <button type="button" onclick="addItem()" id="btnAddItem"
              class="text-sm text-indigo-600 font-bold mb-8 hover:text-indigo-800 flex items-center gap-2 transition p-2 rounded hover:bg-indigo-50">
        <i class="fas fa-plus-circle text-lg"></i> Tambah Baris Baru
      </button>

      <div class="border-t pt-6 text-right">
        <button type="button" onclick="submitInvoice()"
                class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2 ml-auto">
          <i class="fas fa-print"></i> Cetak Invoice PDF
        </button>
      </div>
    </form>
  </div>

</div>

<script>
  let itemCount = 0;
  const MAX_ITEMS = 10;

  window.onload = function () {
    addItem();
    updateItemCountDisplay();
  };

  function updateItemCountDisplay() {
    document.getElementById("itemCount").innerText = `Item: ${itemCount}/${MAX_ITEMS}`;
    const disabled = itemCount >= MAX_ITEMS;
    document.getElementById("btnAddItem").disabled = disabled;
    document.getElementById("btnAddItem").classList.toggle("opacity-50", disabled);
    document.getElementById("btnAddItem").classList.toggle("cursor-not-allowed", disabled);
  }

  function addItem() {
    if (itemCount >= MAX_ITEMS) {
      alert("Maksimal 10 item per invoice.");
      return;
    }
    const tr = document.createElement("tr");
    tr.className = "hover:bg-gray-50 transition";
    tr.innerHTML = `
      <td class="p-2">
        <input type="text" name="item_name"
               class="w-full p-2 border rounded-lg focus:border-indigo-400 outline-none placeholder:opacity-60"
               placeholder="Contoh: Jasa Desain" required>
      </td>
      <td class="p-2">
        <input type="number" name="item_qty" value="1" min="1"
               class="w-full p-2 border rounded-lg text-center focus:border-indigo-400 outline-none"
               required>
      </td>
      <td class="p-2">
        <input type="number" name="item_price" value="" min="1"
               class="w-full p-2 border rounded-lg text-right focus:border-indigo-400 outline-none placeholder:opacity-60"
               placeholder="0" required onchange="validatePrice(this)">
      </td>
      <td class="p-2 text-center">
        <button type="button" onclick="removeItem(this)"
                class="text-red-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50"
                title="Hapus">
          <i class="fas fa-trash-alt"></i>
        </button>
      </td>`;
    document.getElementById("items").appendChild(tr);
    itemCount++;
    updateItemCountDisplay();
  }

  function removeItem(btn) {
    btn.closest("tr").remove();
    itemCount--;
    updateItemCountDisplay();
  }

  function validatePrice(input) {
    if (parseInt(input.value || "0", 10) <= 0) {
      alert("Harga tidak boleh 0 atau negatif!");
      input.value = "";
      input.focus();
    }
  }

  function setTemplate(val) {
    document.getElementById("finalTemplate").value = val;

    const premiumSettings = document.getElementById("premiumSettings");
    const isPremium = {{ 'true' if user.is_premium else 'false' }};

    if (val === "basic") {
      premiumSettings.classList.add("opacity-70", "pointer-events-none");
      const lock = premiumSettings.querySelector(".fa-lock");
      if (lock) lock.classList.remove("hidden");
      return;
    }

    if (!isPremium) {
      alert("Template ini khusus Premium. Silakan upgrade.");
      document.querySelector("input[name='tpl_select'][value='basic']").checked = true;
      setTemplate("basic");
      return;
    }

    premiumSettings.classList.remove("opacity-70", "pointer-events-none");
    const lock = premiumSettings.querySelector(".fa-lock");
    if (lock) lock.classList.add("hidden");
  }

  function syncHiddenFields() {
    document.getElementById("finalBgColor").value = (document.getElementById("bgColorPicker").value || "#ffffff").replace("#", "");
    document.getElementById("finalLineColor").value = (document.getElementById("lineColorPicker").value || "#000000").replace("#", "");
    document.getElementById("finalHeaderTitle").value = document.getElementById("headerTitleInput").value || "INVOICE";
  }

  async function submitInvoice() {
    const form = document.getElementById("invoiceForm");
    if (!form.reportValidity()) return;

    syncHiddenFields();
    const fd = new FormData(form);

    try {
      const res = await fetch("/generate-invoice", { method: "POST", body: fd });
      const html = await res.text();
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
    } catch (e) {
      console.error(e);
      alert("Gagal mengirim data invoice. Coba lagi.");
    }
  }

  async function uploadFile(type) {
    const fileInput = document.getElementById(type === "logo" ? "logoIn" : "sigIn");
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append(type, file);

    const previewId = (type === "logo") ? "previewLogo" : "previewSig";
    const iconId = (type === "logo") ? "noLogoIcon" : "noSigIcon";
    const preview = document.getElementById(previewId);
    const icon = document.getElementById(iconId);

    if (preview) preview.style.opacity = 0.5;

    try {
      const endpoint = (type === "logo") ? "/upload-logo" : "/upload-signature";
      const res = await fetch(endpoint, { method: "POST", body: formData });

      if (res.status === 401 || res.status === 403) {
        alert("Sesi habis atau akses ditolak.");
        return;
      }

      const data = await res.json();
      if (data.success) {
        const url = `/static/uploads/${data.filename}`;
        if (preview) {
          preview.src = url;
          preview.style.opacity = 1;
        } else {
          if (icon) icon.remove();
          const newImg = document.createElement("img");
          newImg.id = previewId;
          newImg.src = url;
          newImg.className = "h-full object-contain";
          fileInput.parentElement.parentElement.querySelector("div").appendChild(newImg);
        }
        alert(type === "logo" ? "Logo berhasil diupdate!" : "Tanda tangan berhasil diupdate!");
      } else {
        alert(data.error || "Upload gagal.");
      }
    } catch (e) {
      console.error(e);
      alert("Gagal koneksi ke server.");
    }
  }

  async function updateAddress() {
    const address = document.getElementById("addressIn").value;

    try {
      const res = await fetch("/update-address", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: address })
      });

      if (res.ok) alert("Alamat berhasil disimpan!");
      else alert("Gagal menyimpan alamat.");
    } catch (e) {
      alert("Error koneksi.");
    }
  }

  // NEW: save company_name, signature_name, signature_title
  async function saveInvoiceProfile() {
    const companyName = document.getElementById("companyNameIn").value || "";
    const signatureName = document.getElementById("sigNameIn").value || "";
    const signatureTitle = document.getElementById("sigTitleIn").value || "";

    try {
      const res = await fetch("/premium/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          company_name: companyName,
          signature_name: signatureName,
          signature_title: signatureTitle
        })
      });

      if (res.status === 401 || res.status === 403) {
        alert("Sesi habis atau akses ditolak.");
        return;
      }

      const data = await res.json().catch(() => ({}));
      if (res.ok && (data.success === undefined || data.success === true)) {
        alert("Profil invoice berhasil disimpan!");
      } else {
        alert(data.error || "Gagal menyimpan profil invoice.");
      }
    } catch (e) {
      console.error(e);
      alert("Error koneksi.");
    }
  }

  async function goPremium() {
    try {
      const res = await fetch("/get-payment-token", { method: "POST" });

      if (res.status === 401) {
        if (confirm("Mode Tamu. Lanjut ke Login untuk upgrade?")) window.location.href = "/login";
        return;
      }

      const data = await res.json();
      if (data.token) {
        window.snap.pay(data.token, {
          onSuccess: async function () {
            await fetch("/payment-success", { method: "POST" });
            alert("Upgrade Berhasil!");
            location.reload();
          },
          onPending: function () { alert("Pembayaran pending."); },
          onError: function () { alert("Pembayaran gagal."); }
        });
      } else {
        alert("Gagal inisiasi pembayaran.");
      }
    } catch (e) {
      alert("Error koneksi payment gateway.");
    }
  }
</script>

</body>
</html>
