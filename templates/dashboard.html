<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>InvoiceInAja</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <!-- CRITICAL FIX: Midtrans Snap Script -->
  <script type="text/javascript"
          src="https://app.sandbox.midtrans.com/snap/snap.js"
          data-client-key="Mid-client-wXRT3UdSUW4t95P6"></script>

  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">

<!-- Navbar -->
<nav class="bg-white shadow-md px-6 py-4 flex justify-between items-center sticky top-0 z-50">
  <div class="flex items-center gap-3">
    <img src="/static/new1invoiceinaja.png" alt="Logo" class="h-8 w-8 object-contain">
    <span class="font-bold text-xl text-indigo-600">InvoiceInAja</span>
  </div>

  <div class="flex items-center gap-4">
    {% if admin %}
      <a href="/admin" class="text-sm text-gray-600 hover:text-indigo-600 transition font-semibold">
        <i class="fas fa-arrow-left"></i> Kembali ke Admin
      </a>
    {% endif %}

    {% if user.username != "Tamu (Guest)" %}
      <span class="text-sm text-gray-700 font-medium">
        Halo, <strong>{{ user.username }}</strong>
        {% if user.is_premium %}
          <span class="ml-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold">
            <i class="fas fa-crown"></i> PREMIUM
          </span>
        {% endif %}
      </span>

      <a href="/logout" class="text-sm text-red-500 hover:text-red-700 transition font-semibold">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    {% else %}
      <a href="/login" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm font-bold">
        <i class="fas fa-sign-in-alt"></i> Login
      </a>
    {% endif %}
  </div>
</nav>

<div class="container mx-auto p-6 max-w-6xl">

  <!-- Premium Banner for Free Users -->
  {% if user.username != "Tamu (Guest)" and not user.is_premium %}
  <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-2xl shadow-lg mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
          <i class="fas fa-crown"></i> Upgrade ke Premium
        </h2>
        <p class="text-indigo-100 mb-4">Dapatkan akses fitur lengkap</p>
        <ul class="space-y-2 text-sm">
          <li><i class="fas fa-check-circle text-green-300"></i> Upload Logo & Tanda Tangan</li>
          <li><i class="fas fa-check-circle text-green-300"></i> Custom Nama Perusahaan</li>
          <li><i class="fas fa-check-circle text-green-300"></i> 3 Template Invoice Premium</li>
        </ul>
      </div>
      <div class="text-right">
        <div class="text-4xl font-bold mb-2">Rp 50.000</div>
        <p class="text-sm text-indigo-200 mb-4">Durasi: 30 Hari</p>
        <button onclick="goPremium()" 
                class="bg-yellow-400 text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-yellow-300 transition shadow-lg">
          <i class="fas fa-bolt"></i> Bayar Sekarang
        </button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Premium Settings (Only for Premium Users) -->
  {% if user.is_premium %}
  <div class="bg-white p-6 rounded-2xl shadow-md mb-6 border border-gray-200">
    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
      <i class="fas fa-user-cog text-indigo-600"></i> Pengaturan Profil Premium
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Logo Upload -->
      <div class="space-y-2">
        <label class="block text-sm font-semibold text-gray-700">
          <i class="fas fa-image text-blue-500"></i> Logo Perusahaan
        </label>
        <input type="file" id="logoInput" accept="image/png,image/jpeg"
               onchange="uploadLogo()"
               class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 
                      file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-700 
                      hover:file:bg-indigo-100 file:cursor-pointer"/>
        <p class="text-xs text-gray-500">PNG/JPG, transparan disarankan.</p>
      </div>

      <!-- Signature Upload -->
      <div class="space-y-2">
        <label class="block text-sm font-semibold text-gray-700">
          <i class="fas fa-signature text-purple-500"></i> Tanda Tangan
        </label>
        <input type="file" id="signatureInput" accept="image/png"
               onchange="uploadSignature()"
               class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 
                      file:rounded-lg file:border-0 file:bg-purple-50 file:text-purple-700 
                      hover:file:bg-purple-100 file:cursor-pointer"/>
        <p class="text-xs text-gray-500">PNG transparan (wajib).</p>
      </div>
    </div>

    <!-- Company Info Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Perusahaan</label>
        <input type="text" id="companyNameInput" 
               value="{{ user.company_name or '' }}"
               placeholder="PT. Contoh Indonesia"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none"/>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Penandatangan</label>
        <input type="text" id="signatureNameInput" 
               value="{{ user.signature_name or '' }}"
               placeholder="Budi Santoso"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none"/>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Jabatan (Opsional)</label>
        <input type="text" id="signatureTitleInput" 
               value="{{ user.signature_title or '' }}"
               placeholder="Direktur Keuangan"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none"/>
      </div>
    </div>

    <!-- Company Address -->
    <div class="mt-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        <i class="fas fa-map-marker-alt text-red-500"></i> Alamat Perusahaan
      </label>
      <textarea id="addressInput" rows="2"
                placeholder="Jl. Contoh No. 123, Jakarta Selatan"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none resize-none">{{ user.company_address or '' }}</textarea>
    </div>

    <!-- Save Button -->
    <button onclick="savePremiumProfile()" 
            class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-bold">
      <i class="fas fa-save"></i> Simpan Profil
    </button>

    <p class="text-xs text-gray-500 mt-2">
      <i class="fas fa-info-circle"></i> Profil ini dipakai untuk template Modern & Corporate (header perusahaan + blok tanda tangan).
    </p>
  </div>
  {% endif %}

  <!-- Invoice Form -->
  <form id="invoiceForm" method="POST" action="/generate-invoice" target="_blank" 
        class="bg-white p-8 rounded-2xl shadow-md border border-gray-200">

    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
      <i class="fas fa-file-invoice text-indigo-600"></i> Buat Invoice Baru
    </h2>

    <!-- Customer Name -->
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        <i class="fas fa-user text-blue-500"></i> Nama Pelanggan
      </label>
      <input type="text" name="customername" required
             placeholder="Nama Perusahaan Pelanggan"
             class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none"/>
    </div>

    <!-- Items Table -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-3">
        <label class="block text-sm font-semibold text-gray-700">
          <i class="fas fa-list text-green-500"></i> Daftar Item/Jasa
        </label>
        <span class="text-xs text-gray-500" id="itemCount">1/10 item</span>
      </div>

      <div class="overflow-x-auto border rounded-xl">
        <table class="w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="p-3 text-left">Nama Item</th>
              <th class="p-3 text-center w-24">Qty</th>
              <th class="p-3 text-right w-40">Harga (Rp)</th>
              <th class="p-3 w-16"></th>
            </tr>
          </thead>
          <tbody id="items">
            <tr class="hover:bg-gray-50 transition">
              <td class="p-2">
                <input type="text" name="itemname" required
                       placeholder="Contoh: Jasa Konsultasi"
                       class="w-full p-2 border rounded-lg focus:border-indigo-400 outline-none"/>
              </td>
              <td class="p-2">
                <input type="number" name="itemqty" value="1" min="1" required
                       class="w-full p-2 border rounded-lg text-center focus:border-indigo-400 outline-none"/>
              </td>
              <td class="p-2">
                <input type="number" name="itemprice" value="" min="1" required
                       placeholder="0"
                       class="w-full p-2 border rounded-lg text-right focus:border-indigo-400 outline-none"/>
              </td>
              <td class="p-2 text-center">
                <button type="button" onclick="removeItem(this)" 
                        class="text-red-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button type="button" onclick="addItem()" 
              class="mt-3 text-indigo-600 hover:text-indigo-800 font-semibold text-sm">
        <i class="fas fa-plus-circle"></i> Tambah Item
      </button>
    </div>

    <!-- Template Selection (Premium Only) -->
    {% if user.is_premium %}
    <div class="mb-6">
      <label class="block text-sm font-semibold text-gray-700 mb-3">
        <i class="fas fa-palette text-purple-500"></i> Pilih Template
      </label>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <label class="cursor-pointer">
          <input type="radio" name="template_select" value="basic" checked class="peer sr-only"/>
          <div class="p-4 border-2 rounded-lg text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:border-gray-400 transition">
            <i class="fas fa-file-alt text-2xl text-gray-600 mb-2"></i>
            <div class="text-xs font-semibold">Basic</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="template_select" value="modern" class="peer sr-only"/>
          <div class="p-4 border-2 rounded-lg text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:border-gray-400 transition">
            <i class="fas fa-star text-2xl text-indigo-600 mb-2"></i>
            <div class="text-xs font-semibold">Modern</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="template_select" value="minimalist" class="peer sr-only"/>
          <div class="p-4 border-2 rounded-lg text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:border-gray-400 transition">
            <i class="fas fa-minimize text-2xl text-gray-600 mb-2"></i>
            <div class="text-xs font-semibold">Minimalist</div>
          </div>
        </label>

        <label class="cursor-pointer">
          <input type="radio" name="template_select" value="corporate" class="peer sr-only"/>
          <div class="p-4 border-2 rounded-lg text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:border-gray-400 transition">
            <i class="fas fa-building text-2xl text-blue-600 mb-2"></i>
            <div class="text-xs font-semibold">Corporate</div>
          </div>
        </label>
      </div>
    </div>
    {% endif %}

    <!-- Hidden Form Fields -->
    <input type="hidden" name="template" id="finalTemplate" value="basic">
    <input type="hidden" name="bgcolor" id="finalBgColor" value="ffffff">
    <input type="hidden" name="linecolor" id="finalLineColor" value="000000">
    <input type="hidden" name="headertitle" id="finalHeaderTitle" value="INVOICE">

    <!-- Submit Button -->
    <button type="submit" 
            class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg">
      <i class="fas fa-print"></i> Generate & Cetak Invoice
    </button>
  </form>

</div>

<!-- Premium Modal -->
<div id="premiumModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
    <h3 class="text-2xl font-bold text-gray-800 mb-4">Konfirmasi Pembayaran</h3>
    <p class="text-gray-600 mb-6">Anda akan melanjutkan ke payment gateway Midtrans untuk pembayaran sebesar:</p>
    <div class="text-4xl font-bold text-indigo-600 mb-6 text-center">Rp 50.000</div>

    <div class="flex gap-3">
      <button onclick="closePremiumModal()" 
              class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300 transition">
        Batal
      </button>
      <button onclick="processPremiumPayment()" 
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
        Lanjutkan
      </button>
    </div>
  </div>
</div>

<script>
// Item management
let itemCount = 1;
const MAX_ITEMS = 10;

function addItem() {
  if (itemCount >= MAX_ITEMS) {
    alert("Maksimal 10 item per invoice.");
    return;
  }

  const tr = document.createElement("tr");
  tr.className = "hover:bg-gray-50 transition";
  tr.innerHTML = `
    <td class="p-2">
      <input type="text" name="itemname" required
             placeholder="Contoh: Jasa Desain"
             class="w-full p-2 border rounded-lg focus:border-indigo-400 outline-none"/>
    </td>
    <td class="p-2">
      <input type="number" name="itemqty" value="1" min="1" required
             class="w-full p-2 border rounded-lg text-center focus:border-indigo-400 outline-none"/>
    </td>
    <td class="p-2">
      <input type="number" name="itemprice" value="" min="1" required
             placeholder="0"
             class="w-full p-2 border rounded-lg text-right focus:border-indigo-400 outline-none"/>
    </td>
    <td class="p-2 text-center">
      <button type="button" onclick="removeItem(this)"
              class="text-red-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50">
        <i class="fas fa-trash-alt"></i>
      </button>
    </td>`;

  document.getElementById("items").appendChild(tr);
  itemCount++;
  updateItemCountDisplay();
}

function removeItem(btn) {
  if (itemCount <= 1) {
    alert("Minimal harus ada 1 item.");
    return;
  }
  btn.closest("tr").remove();
  itemCount--;
  updateItemCountDisplay();
}

function updateItemCountDisplay() {
  document.getElementById("itemCount").textContent = `${itemCount}/10 item`;
}

// Form submission
document.getElementById("invoiceForm").onsubmit = function(e) {
  const template = document.querySelector('input[name="template_select"]:checked');
  if (template) {
    document.getElementById("finalTemplate").value = template.value;
  }
};

// Premium profile functions
async function uploadLogo() {
  const file = document.getElementById("logoInput").files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("logo", file);

  try {
    const res = await fetch("/upload-logo", { method: "POST", body: formData });
    const data = await res.json();

    if (data.success) {
      alert("✅ Logo berhasil diupload!");
    } else {
      alert("❌ Gagal upload: " + (data.error || "Unknown error"));
    }
  } catch (e) {
    alert("❌ Error: " + e.message);
  }
}

async function uploadSignature() {
  const file = document.getElementById("signatureInput").files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("signature", file);

  try {
    const res = await fetch("/upload-signature", { method: "POST", body: formData });
    const data = await res.json();

    if (data.success) {
      alert("✅ Tanda tangan berhasil diupload!");
    } else {
      alert("❌ Gagal upload: " + (data.error || "Unknown error"));
    }
  } catch (e) {
    alert("❌ Error: " + e.message);
  }
}

async function savePremiumProfile() {
  const companyName = document.getElementById("companyNameInput").value.trim();
  const signatureName = document.getElementById("signatureNameInput").value.trim();
  const signatureTitle = document.getElementById("signatureTitleInput").value.trim();
  const address = document.getElementById("addressInput").value.trim();

  try {
    // Save company info
    const res1 = await fetch("/premium/profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        company_name: companyName,
        signature_name: signatureName,
        signature_title: signatureTitle
      })
    });

    // Save address
    const res2 = await fetch("/update_address", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address: address })
    });

    if (res1.ok && res2.ok) {
      alert("✅ Profil berhasil disimpan!");
      location.reload();
    } else {
      alert("❌ Gagal menyimpan profil.");
    }
  } catch (e) {
    alert("❌ Error: " + e.message);
  }
}

// Payment functions - CRITICAL FIX
async function goPremium() {
  console.log("=== GO PREMIUM CLICKED ===");

  try {
    const res = await fetch("/get-payment-token", { method: "POST" });
    console.log("Payment token response status:", res.status);

    if (res.status === 401) {
      if (confirm("Mode Tamu. Lanjut ke Login untuk upgrade?")) {
        window.location.href = "/login";
      }
      return;
    }

    if (res.status === 403) {
      alert("Anda sudah Premium!");
      return;
    }

    const data = await res.json();
    console.log("Payment token data:", data);

    if (data.error) {
      alert("Error: " + data.error);
      return;
    }

    if (!data.token) {
      alert("Token pembayaran tidak ditemukan. Coba lagi.");
      return;
    }

    // Simpan token untuk digunakan nanti
    window.paymentToken = data.token;
    console.log("Token saved successfully:", window.paymentToken);

    // Tampilkan modal konfirmasi
    document.getElementById("premiumModal").classList.remove("hidden");

  } catch (e) {
    console.error("Error fetching payment token:", e);
    alert("Error koneksi ke server: " + e.message);
  }
}

function closePremiumModal() {
  document.getElementById("premiumModal").classList.add("hidden");
}

// Function untuk proses pembayaran setelah konfirmasi
function processPremiumPayment() {
  console.log("=== PROCESS PAYMENT CLICKED ===");
  
  if (!window.paymentToken) {
    alert("Token pembayaran tidak valid. Silakan coba lagi.");
    closePremiumModal();
    return;
  }

  console.log("Payment token:", window.paymentToken);

  // PENTING: Validasi Snap loaded
  if (typeof window.snap === 'undefined') {
    console.error("ERROR: Snap.js not loaded!");
    alert("❌ Payment gateway belum siap. Refresh halaman (F5) dan coba lagi.");
    closePremiumModal();
    return;
  }

  console.log("Snap.js loaded successfully");

  // Tutup modal
  closePremiumModal();

  // Proses pembayaran via Midtrans Snap
  try {
    console.log("Calling snap.pay()...");
    
    window.snap.pay(window.paymentToken, {
      onSuccess: async function (result) {
        console.log("✅ Payment success:", result);
        try {
          const res = await fetch("/payment-success", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: result.order_id })
          });
          
          if (res.ok) {
            alert("✅ Upgrade Berhasil! Selamat menikmati fitur Premium.");
            location.reload();
          } else {
            alert("Pembayaran berhasil tapi gagal update status. Refresh halaman.");
            location.reload();
          }
        } catch (e) {
          console.error("Error updating payment status:", e);
          alert("Pembayaran berhasil. Refresh halaman untuk melihat perubahan.");
          location.reload();
        }
      },
      
      onPending: function (result) {
        console.log("⏳ Payment pending:", result);
        alert("⏳ Pembayaran sedang diproses. Cek email/notifikasi Anda.");
      },
      
      onError: function (result) {
        console.error("❌ Payment error:", result);
        alert("❌ Pembayaran gagal: " + (result.status_message || "Silakan coba lagi"));
      },
      
      onClose: function () {
        console.log("Payment popup closed by user");
      }
    });
    
  } catch (e) {
    console.error("EXCEPTION calling snap.pay:", e);
    alert("❌ Gagal membuka payment gateway: " + e.message);
  }
}

</script>

</body>
</html>
